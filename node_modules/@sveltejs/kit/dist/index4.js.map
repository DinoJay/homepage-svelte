{"version":3,"file":"index4.js","sources":["../src/api/start/index.js"],"sourcesContent":["import * as fs from 'fs';\nimport * as http from 'http';\nimport { parse, URLSearchParams } from 'url';\nimport sirv from 'sirv';\nimport { get_body } from '@sveltejs/app-utils/http';\nimport { join, resolve } from 'path';\n\nconst mutable = (dir) =>\n\tsirv(dir, {\n\t\tetag: true,\n\t\tmaxAge: 0\n\t});\n\nexport async function start({ port, config }) {\n\tconst app_file = resolve('.svelte/build/optimized/server/app.js');\n\tconst app = await import(app_file);\n\n\tconst static_handler = fs.existsSync(config.files.assets)\n\t\t? mutable(config.files.assets)\n\t\t: (_req, _res, next) => next();\n\n\tconst assets_handler = sirv('.svelte/build/optimized/client', {\n\t\tmaxAge: 31536000,\n\t\timmutable: true\n\t});\n\n\treturn new Promise((fulfil) => {\n\t\tconst server = http.createServer((req, res) => {\n\t\t\tconst parsed = parse(req.url || '');\n\n\t\t\tassets_handler(req, res, () => {\n\t\t\t\tstatic_handler(req, res, async () => {\n\t\t\t\t\tconst rendered = await app.render(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmethod: req.method,\n\t\t\t\t\t\t\theaders: req.headers,\n\t\t\t\t\t\t\tpath: parsed.pathname,\n\t\t\t\t\t\t\tbody: await get_body(req),\n\t\t\t\t\t\t\tquery: new URLSearchParams(parsed.query || '')\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpaths: {\n\t\t\t\t\t\t\t\tbase: '',\n\t\t\t\t\t\t\t\tassets: '/.'\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tget_stack: (error) => error.stack, // TODO should this return a sourcemapped stacktrace?\n\t\t\t\t\t\t\tget_static_file: (file) => fs.readFileSync(join(config.files.assets, file))\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tif (rendered) {\n\t\t\t\t\t\tres.writeHead(rendered.status, rendered.headers);\n\t\t\t\t\t\tres.end(rendered.body);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tres.statusCode = 404;\n\t\t\t\t\t\tres.end('Not found');\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tserver.listen(port, () => {\n\t\t\tfulfil(server);\n\t\t});\n\n\t\treturn server;\n\t});\n}\n"],"names":["fs.existsSync","http.createServer","fs.readFileSync"],"mappings":";;;;;;;AAOA,MAAM,OAAO,GAAG,CAAC,GAAG;AACpB,CAAC,IAAI,CAAC,GAAG,EAAE;AACX,EAAE,IAAI,EAAE,IAAI;AACZ,EAAE,MAAM,EAAE,CAAC;AACX,EAAE,CAAC,CAAC;AACJ;AACO,eAAe,KAAK,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;AAC9C,CAAC,MAAM,QAAQ,GAAG,OAAO,CAAC,uCAAuC,CAAC,CAAC;AACnE,CAAC,MAAM,GAAG,GAAG,MAAM,OAAO,QAAQ,CAAC,CAAC;AACpC;AACA,CAAC,MAAM,cAAc,GAAGA,UAAa,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC;AAC1D,IAAI,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC;AAChC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,KAAK,IAAI,EAAE,CAAC;AACjC;AACA,CAAC,MAAM,cAAc,GAAG,IAAI,CAAC,gCAAgC,EAAE;AAC/D,EAAE,MAAM,EAAE,QAAQ;AAClB,EAAE,SAAS,EAAE,IAAI;AACjB,EAAE,CAAC,CAAC;AACJ;AACA,CAAC,OAAO,IAAI,OAAO,CAAC,CAAC,MAAM,KAAK;AAChC,EAAE,MAAM,MAAM,GAAGC,YAAiB,CAAC,CAAC,GAAG,EAAE,GAAG,KAAK;AACjD,GAAG,MAAM,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,GAAG,IAAI,EAAE,CAAC,CAAC;AACvC;AACA,GAAG,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE,MAAM;AAClC,IAAI,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE,YAAY;AACzC,KAAK,MAAM,QAAQ,GAAG,MAAM,GAAG,CAAC,MAAM;AACtC,MAAM;AACN,OAAO,MAAM,EAAE,GAAG,CAAC,MAAM;AACzB,OAAO,OAAO,EAAE,GAAG,CAAC,OAAO;AAC3B,OAAO,IAAI,EAAE,MAAM,CAAC,QAAQ;AAC5B,OAAO,IAAI,EAAE,MAAM,QAAQ,CAAC,GAAG,CAAC;AAChC,OAAO,KAAK,EAAE,IAAI,eAAe,CAAC,MAAM,CAAC,KAAK,IAAI,EAAE,CAAC;AACrD,OAAO;AACP,MAAM;AACN,OAAO,KAAK,EAAE;AACd,QAAQ,IAAI,EAAE,EAAE;AAChB,QAAQ,MAAM,EAAE,IAAI;AACpB,QAAQ;AACR,OAAO,SAAS,EAAE,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK;AACxC,OAAO,eAAe,EAAE,CAAC,IAAI,KAAKC,YAAe,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;AAClF,OAAO;AACP,MAAM,CAAC;AACP;AACA,KAAK,IAAI,QAAQ,EAAE;AACnB,MAAM,GAAG,CAAC,SAAS,CAAC,QAAQ,CAAC,MAAM,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAC;AACvD,MAAM,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;AAC7B,MAAM,MAAM;AACZ,MAAM,GAAG,CAAC,UAAU,GAAG,GAAG,CAAC;AAC3B,MAAM,GAAG,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AAC3B,MAAM;AACN,KAAK,CAAC,CAAC;AACP,IAAI,CAAC,CAAC;AACN,GAAG,CAAC,CAAC;AACL;AACA,EAAE,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,MAAM;AAC5B,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC;AAClB,GAAG,CAAC,CAAC;AACL;AACA,EAAE,OAAO,MAAM,CAAC;AAChB,EAAE,CAAC,CAAC;AACJ;;;;"}